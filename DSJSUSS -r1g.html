<html lang="pt-BR"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dual.Infodose ¬∑ Mini M√≥dulo Config DI</title>
  <meta name="theme-color" content="#050715">

  <style>
    /* --- (Mantive o CSS original intacto para preservar o visual) --- */
    :root {
      --bg: radial-gradient(circle at 20% 20%, #121926, #050811 60%, #000000 100%);
      --text: #e4ecff;
      --accent: #00f5ff;
      --accent-soft: rgba(0, 245, 255, .18);
      --danger: #ff4b6b;
      --shadow-soft: 0 18px 40px rgba(0,0,0,.65);
      --fast: .25s; --med: .6s; --slow: 1.4s;
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    html, body { width:100%; height:100%; margin:0; padding:0 16px 96px; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, sans-serif; }
    
    .dual-chat-module { position: fixed; left: 50%; transform: translateX(-50%); bottom: calc(69px + env(safe-area-inset-bottom)); width: min(520px, calc(100% - 32px)); max-width: 520px; display:flex; flex-direction:column; gap:10px; z-index: 1200; transition: transform .22s ease; }
    .dual-chat-module.collapsed { transform: translateX(-50%) translateY(6px); }

    .response-container { border-radius:20px; background: radial-gradient(circle at 0 0, rgba(0,255,255,.14), rgba(0,0,0,.86)); backdrop-filter: blur(14px) saturate(160%); box-shadow: var(--shadow-soft); padding:12px; display:flex; flex-direction:column; gap:8px; max-height:60vh; overflow-y:auto; animation: fadeInUp var(--slow) ease forwards; }
    @keyframes fadeInUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }

    .pages-wrapper { width:100%; display:flex; flex-direction:column; gap:10px; }
    .page { display:none; opacity:0; transition:opacity var(--med) ease; }
    .page.active { display:block; opacity:1; }
    .page.initial { min-height:90px; display:flex; align-items:center; justify-content:center; text-align:center; }

    #bootText { font-weight:700; position:relative; letter-spacing:.03em; }
    #bootText.pulse::after { content: attr(data-text); position:absolute; inset:0; background:linear-gradient(42deg,#0ff,#f0f); -webkit-background-clip:text; -webkit-text-fill-color:transparent; filter:blur(4px); opacity:.45; animation:pulseGlow 3s ease-in-out infinite; }
    @keyframes pulseGlow { 0%,100% { opacity:0.4; } 50% { opacity:0.9; } }

    .response-block { margin:.35rem 0; padding:1rem 1.1rem; border-radius:14px; line-height:1.7; font-size:.9rem; border:1px solid rgba(255,255,255,.04); background: linear-gradient(135deg, rgba(255,255,255,.02), rgba(6,10,28,.95)); }
    .response-block.intro { background:linear-gradient(135deg, rgba(0,255,255,.18), rgba(0,40,70,.9)); }
    .response-block.ending { background:linear-gradient(135deg, rgba(255,0,255,.18), rgba(40,0,60,.95)); }
    .response-block h1, .response-block h2, .response-block h3 { margin-bottom:.2rem; }
    .response-block code { font-family:monospace; font-size:.8rem; padding:.15rem .32rem; border-radius:6px; background:rgba(0,0,0,.5); }
    .response-block ul { padding-left:18px; margin:.35rem 0; }
    
    .lv-callout { border-radius:12px; padding:6px 8px; margin:4px 0; font-size:.8rem; line-height:1.5; }
    .lv-callout.info { border:1px solid rgba(0,255,255,.45); background:rgba(0,255,255,.06); }
    
    .footer-text { margin-top:4px; padding:6px 10px; font-size:.78rem; text-align:center; opacity:.8; border-radius:999px; border:1px solid rgba(255,255,255,.16); background:rgba(0,0,0,.65); cursor:pointer; display:inline-flex; align-items:center; justify-content:center; gap:6px; }
    .footer-dot { width:6px; height:6px; border-radius:50%; background:linear-gradient(45deg,#0ff,#f0f); box-shadow:0 0 12px rgba(0,255,255,.7); }

    .response-controls { margin-top:6px; padding-top:6px; border-top:1px solid rgba(255,255,255,.12); display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:.8rem; }
    .control-buttons, .pagination { display:flex; align-items:center; gap:8px; }
    .icon-btn { width:30px; height:30px; border-radius:50%; border:none; background:rgba(0,0,0,.7); color:var(--accent); cursor:pointer; display:flex; align-items:center; justify-content:center; }
    .pagination button { border:none; background:none; font-size:1.1rem; cursor:pointer; background:linear-gradient(45deg,#0ff,#f0f); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    #iaConfigPanel { margin-top:6px; padding:8px 10px; border-radius:16px; background:rgba(0, 8, 20, .96); border:1px solid rgba(0,255,255,.24); display:none; flex-direction:column; gap:6px; }
    #iaConfigPanel.active { display:flex; }
    #iaConfigHeader { display:flex; align-items:center; justify-content:space-between; }
    .ia-close-btn { border:none; border-radius:50%; background:rgba(0,0,0,.7); color:white; width:24px; height:24px; cursor:pointer; }
    .ia-field { display:flex; flex-direction:column; gap:3px; }
    .ia-field input, .ia-field select { width:100%; border-radius:8px; border:1px solid rgba(0,255,255,.3); background:rgba(0,0,0,.7); color:inherit; padding:5px 7px; font-size:.78rem; outline:none; }
    .ia-actions { display:flex; gap:6px; margin-top:4px; }
    .pill-btn { flex:1; border-radius:999px; border:1px solid rgba(0,255,255,.6); background:transparent; padding:5px 0; font-size:.78rem; cursor:pointer; color:var(--accent); }
    .pill-btn:hover { background:var(--accent); color:#050515; }
    .ia-status { font-size:.7rem; opacity:.8; }
    .ia-status.ok { color:#63f8ba; } .ia-status.warn { color:#ffd480; }

    .input-container { display:flex; gap:8px; align-items:center; }
    #userInput { flex:1; padding:11px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.16); background:rgba(0,0,0,.7); color:inherit; font-size:.95rem; outline:none; }
    #sendBtn { width:50px; height:50px; border-radius:50%; border:none; background:conic-gradient(from 120deg,#0ff,#f0f,#0ff); font-size:1.4rem; cursor:pointer; }
    #voiceBtn { width:46px; height:46px; border-radius:50%; border:none; background:rgba(0,0,0,.75); color:var(--accent); font-size:1rem; cursor:pointer; }
    #voiceBtn.recording { box-shadow:0 0 22px rgba(0,255,180,.8); background:radial-gradient(circle at 30% 0, rgba(0,255,180,.7), rgba(0,0,0,.9)); }

    .dual-chat-module.collapsed .pages-wrapper, 
    .dual-chat-module.collapsed .response-controls, 
    .dual-chat-module.collapsed #iaConfigPanel,
    .dual-chat-module.collapsed .input-container { display:none; }
  </style>
</head>
<body>

  <div class="dual-chat-module" id="dualChatModule" aria-live="polite">
    <div class="response-container" id="response">
      <div class="pages-wrapper" id="pagesWrapper">
        <div class="page initial active" data-page-index="0">
          <strong id="bootText" class="pulse" data-text="...">
            üß¨ Carregando configura√ß√µes DI...
          </strong>
        </div>
      </div>

      <p class="footer-text" id="footerHint">
        <span class="footer-dot"></span>
        Configura√ß√µes DI Ativas.
      </p>

      <div class="response-controls">
        <div class="control-buttons">
          <button class="icon-btn" id="copyBtn">‚ßâ</button>
          <button class="icon-btn" id="toggleSettingsBtn">‚öô</button>
        </div>
        <div class="pagination">
          <button id="pagePrev">‚üµ</button>
          <span id="pageIndicator">1 / 1</span>
          <button id="pageNext">‚ü∂</button>
        </div>
      </div>

      <div id="iaConfigPanel">
        <div id="iaConfigHeader">
          <span>Config DI ¬∑ Storage</span>
          <button type="button" class="ia-close-btn" id="closeIaConfigPanelBtn">‚úï</button>
        </div>
        <div class="ia-config-body">
          <div class="ia-field">
            <label for="apiKeyInput">DI API Key (di_apiKey)</label>
            <input id="apiKeyInput" type="password" placeholder="sk-or-..." autocomplete="off">
          </div>
          <div class="ia-field">
            <label for="modelSelect">Modelo (di_modelName)</label>
            <select id="modelSelect">
              <option value="deepseek/deepseek-chat-v3-0324:free">deepseek-v3 ¬∑ free</option>
              <option value="meta-llama/llama-3.1-70b-instruct:free">Llama 3.1 70B ¬∑ free</option>
              <option value="openai/gpt-4.1-mini">GPT-4.1 mini</option>
              <option value="custom">Custom (digitar)</option>
            </select>
          </div>
          <div class="ia-field">
            <label for="customModelInput">Modelo Custom</label>
            <input id="customModelInput" type="text" placeholder="ex: google/gemini-2.0-flash-exp:free">
          </div>
          <div class="ia-actions">
            <button class="pill-btn" id="saveIaConfigBtn" type="button">Salvar Config DI</button>
            <button class="pill-btn secondary" id="clearIaConfigBtn" type="button">Limpar Tudo</button>
          </div>
          <div class="ia-status" id="iaStatus">Verificando storage...</div>
        </div>
      </div>
    </div>

    <div class="input-container">
      <input id="userInput" type="text" placeholder="Digite sua mensagem...">
      <button id="sendBtn" type="button">‚û§</button>
      <button id="voiceBtn" type="button">üîò</button>
    </div>
  </div>

  <script>
    (function(){
      let didInit = false;

      // === CONFIGURA√á√ÉO DAS CHAVES DI (Dual Infodose) ===
      const STORAGE = {
        API_KEY:       'di_apiKey',
        MODEL_NAME:    'di_modelName',
        USER_NAME:     'di_userName',
        INFODOSE_NAME: 'di_infodoseName',
        SYSTEM_ROLE:   'di_systemRole'
      };

      const DEFAULTS = {
        API_URL: 'https://openrouter.ai/api/v1/chat/completions',
        MODEL:   'deepseek/deepseek-chat-v3-0324:free',
        TEMP:    0.2,
        INFODOSE: 'Dual.Infodose',
        USER: 'Viajante'
      };

      let CONFIG = {
        API_URL: DEFAULTS.API_URL,
        MODEL:   DEFAULTS.MODEL,
        TEMP:    DEFAULTS.TEMP,
        AUTH_TOKEN: '',
        USER_NAME: DEFAULTS.USER,
        INFODOSE_NAME: DEFAULTS.INFODOSE,
        SYSTEM_ROLE: ''
      };

      // Helper DOM
      const $  = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));

      // Elementos
      const moduleRoot     = $('#dualChatModule');
      const responseContainer = $('#response');
      const pagesWrapper   = $('#pagesWrapper');
      const bootText       = $('#bootText');
      const footerHint     = $('#footerHint');
      const apiKeyInput    = $('#apiKeyInput');
      const modelSelect    = $('#modelSelect');
      const customModelInput = $('#customModelInput');
      const iaStatus       = $('#iaStatus');
      const userInput      = $('#userInput');
      
      let pages = [];
      let currentPage = 0;
      let isCollapsed = false;
      let conversation = []; // Hist√≥rico simples

      // ==========================================
      // 1. CARREGAMENTO E SALVAMENTO (DI KEYS)
      // ==========================================

      function updateBootUI() {
        // Atualiza a frase inicial com os nomes configurados
        const txt = `üß¨ Iniciando. Pulso simbi√≥tico detectado. Ol√°, ${CONFIG.USER_NAME}. Sou ${CONFIG.INFODOSE_NAME}.`;
        bootText.textContent = txt;
        bootText.setAttribute('data-text', txt);
        userInput.placeholder = `Diga: 'oi, ${CONFIG.INFODOSE_NAME}'...`;
      }

      function loadIaConfig(){
        // Ler do LocalStorage usando as chaves DI
        const key   = localStorage.getItem(STORAGE.API_KEY) || '';
        const model = localStorage.getItem(STORAGE.MODEL_NAME) || DEFAULTS.MODEL;
        const uName = localStorage.getItem(STORAGE.USER_NAME) || DEFAULTS.USER;
        const iName = localStorage.getItem(STORAGE.INFODOSE_NAME) || DEFAULTS.INFODOSE;
        const sysRole = localStorage.getItem(STORAGE.SYSTEM_ROLE) || '';

        // Atualizar runtime config
        CONFIG.AUTH_TOKEN = key ? 'Bearer ' + key : '';
        CONFIG.MODEL      = model;
        CONFIG.USER_NAME  = uName;
        CONFIG.INFODOSE_NAME = iName;
        CONFIG.SYSTEM_ROLE = sysRole;

        // Atualizar UI Inputs
        apiKeyInput.value = key;
        
        // Logica do Select vs Custom
        let found = false;
        Array.from(modelSelect.options).forEach(opt => {
          if (opt.value === model){ found = true; modelSelect.value = model; }
        });
        if (!found){
          modelSelect.value = 'custom';
          customModelInput.value = model;
        } else {
            customModelInput.value = '';
        }

        // Feedback Status
        if (!key){
          iaStatus.textContent = 'Falta di_apiKey no storage.';
          iaStatus.className = 'ia-status warn';
        } else {
          iaStatus.textContent = `Config DI carregada. Modelo: ${model}`;
          iaStatus.className = 'ia-status ok';
        }

        updateBootUI();
      }

      function saveIaConfig(){
        // Pega valores da UI
        let key = apiKeyInput.value.trim();
        let model = modelSelect.value;
        if (model === 'custom'){
          const c = customModelInput.value.trim();
          if (c) model = c;
        }
        if (!model) model = DEFAULTS.MODEL;

        if (!key){
          iaStatus.textContent = 'Preencha a API Key para salvar.';
          iaStatus.className = 'ia-status warn';
          return;
        }

        try{
          // Salva nas chaves DI
          localStorage.setItem(STORAGE.API_KEY, key);
          localStorage.setItem(STORAGE.MODEL_NAME, model);
          // Nota: N√£o estamos salvando user/infodose aqui via UI, 
          // isso geralmente vem de fora ou mantemos o que j√° estava.
        }catch(e){ console.error(e); }

        loadIaConfig(); // Recarrega para aplicar
        iaStatus.textContent = 'Configura√ß√µes DI salvas!';
      }

      function clearIaConfig(){
        try{
          localStorage.removeItem(STORAGE.API_KEY);
          localStorage.removeItem(STORAGE.MODEL_NAME);
          localStorage.removeItem(STORAGE.USER_NAME);
          localStorage.removeItem(STORAGE.INFODOSE_NAME);
          localStorage.removeItem(STORAGE.SYSTEM_ROLE);
        }catch(e){ console.error(e); }
        
        loadIaConfig();
        iaStatus.textContent = 'Configura√ß√µes DI limpas.';
        iaStatus.className = 'ia-status warn';
      }

      // ==========================================
      // 2. CHAMADA IA (USANDO DI_SYSTEMROLE)
      // ==========================================

      async function callOpenRouter(promptText){
        if (!CONFIG.AUTH_TOKEN){
          throw new Error('Chave DI n√£o configurada.');
        }

        // Se o sistema n√£o tiver role definida no storage, usa o fallback cinematogr√°fico
        const fallbackSystem = `Voc√™ √© ${CONFIG.INFODOSE_NAME}, assistente cinematogr√°fico. O usu√°rio √© ${CONFIG.USER_NAME}.
Responda em portugu√™s, usando blocos Markdown e callouts (::info, ::warn).
Estrutura: 1) Recompensa inicial, 2) Curiosidade no meio, 3) Convite final.`;

        const finalSystem = CONFIG.SYSTEM_ROLE && CONFIG.SYSTEM_ROLE.trim().length > 0 
            ? CONFIG.SYSTEM_ROLE 
            : fallbackSystem;

        const messages = [
          { role:'system', content: finalSystem },
          ...conversation.slice(-4), // Mant√©m contexto curto
          { role:'user', content: promptText }
        ];

        const body = {
          model: CONFIG.MODEL,
          temperature: CONFIG.TEMP,
          messages
        };

        const res = await fetch(CONFIG.API_URL, {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization': CONFIG.AUTH_TOKEN
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) throw new Error(`Erro API: ${res.status}`);
        const data = await res.json();
        const content = data.choices?.[0]?.message?.content || '...';
        
        conversation.push({ role:'user', content: promptText });
        conversation.push({ role:'assistant', content });
        return content;
      }

      // ==========================================
      // 3. UI E INTERA√á√ÉO B√ÅSICA
      // ==========================================

      // Parser simples para visualiza√ß√£o (estilo Livro Vivo)
      function parseToHtml(text){
        if (!text) return '';
        let out = text
          .replace(/^### (.*)$/gim, '<h3>$1</h3>')
          .replace(/^## (.*)$/gim, '<h2>$1</h2>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/::(info|warn|success)(.*)/gim, '<div class="lv-callout $1">$2</div>')
          .replace(/\n/g, '<br/>');
        return out;
      }

      function renderResponse(text){
        // Cria uma p√°gina simples
        const div = document.createElement('div');
        div.className = 'page active';
        div.innerHTML = `<div class="response-block middle">${parseToHtml(text)}</div>`;
        
        // Limpa anteriores por simplicidade neste exemplo
        pagesWrapper.innerHTML = '';
        pagesWrapper.appendChild(div);
      }

      async function handleSend(){
        const txt = userInput.value.trim();
        if(!txt) return;
        
        userInput.value = '';
        footerHint.textContent = `Pulsando para ${CONFIG.MODEL}...`;
        
        try {
            const answer = await callOpenRouter(txt);
            renderResponse(answer);
            footerHint.textContent = 'Resposta recebida.';
        } catch(e) {
            renderResponse(`::warn Falha: ${e.message}`);
            footerHint.textContent = 'Erro de conex√£o.';
        }
      }

      // Listeners
      $('#sendBtn').addEventListener('click', handleSend);
      userInput.addEventListener('keydown', e => { if(e.key === 'Enter') handleSend(); });
      
      $('#toggleSettingsBtn').addEventListener('click', () => {
        const p = $('#iaConfigPanel');
        p.classList.toggle('active');
        if(p.classList.contains('active')) loadIaConfig();
      });
      $('#closeIaConfigPanelBtn').addEventListener('click', () => $('#iaConfigPanel').classList.remove('active'));
      $('#saveIaConfigBtn').addEventListener('click', saveIaConfig);
      $('#clearIaConfigBtn').addEventListener('click', clearIaConfig);
      $('#footerHint').addEventListener('click', () => {
         moduleRoot.classList.toggle('collapsed');
      });

      // ==========================================
      // 4. API EXTERNA E MENSAGENS DO HOST
      // ==========================================

      // API P√∫blica para scripts externos
      window.Hub1DualInfodose = {
        // Define identidade programaticamente
        setIdentity: (data) => {
            if(data.user) localStorage.setItem(STORAGE.USER_NAME, data.user);
            if(data.infodose) localStorage.setItem(STORAGE.INFODOSE_NAME, data.infodose);
            if(data.role) localStorage.setItem(STORAGE.SYSTEM_ROLE, data.role);
            loadIaConfig(); // Atualiza UI instantaneamente
            console.log('Dual Infodose: Identidade atualizada via Script.');
        },
        send: (txt) => { userInput.value = txt; handleSend(); }
      };

      // Listener de mensagens do Host (Window Message)
      window.addEventListener('message', (ev) => {
        const data = ev.data;
        if (!data || data.source !== 'hub1.host') return;

        // Setar API KEY via host
        if (data.type === 'hub1.dual.setToken' && data.payload?.token){
          localStorage.setItem(STORAGE.API_KEY, data.payload.token);
          loadIaConfig();
        }
        
        // Setar Identidade via host
        if (data.type === 'hub1.dual.setIdentity'){
           window.Hub1DualInfodose.setIdentity(data.payload);
        }
      });

      // Boot
      function init(){
        if(didInit) return;
        didInit = true;
        loadIaConfig();
      }
      document.addEventListener('DOMContentLoaded', init);
      init();

    })();
  </script>
</body></html>
